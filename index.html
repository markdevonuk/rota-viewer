<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Event Rota Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
<style>
body { padding: 1rem; background-color: #f9f9f9; }
h2 { font-size: 1.8rem; font-weight: bold; margin-bottom: 0; }
.shift-header { margin-top: 3rem; text-align: center; }
.section-header { margin-top: 2rem; font-size: 1.5rem; font-weight: bold; }
.card { border-radius: 0.75rem; }
.badge-early { background-color: #0d6efd; color: #fff; font-size: 1rem; }
.badge-late { background-color: #6f42c1; color: #fff; font-size: 1rem; }
.badge-night { background-color: #212529; color: #fff; font-size: 1rem; }
.card-leadership { background-color: #e7f3ff; }
.card-vehicles { background-color: #f0f0f0; }
.card-responders { background-color: #e8fbe8; }
.card-static { background-color: #ffe4e1; }
.card-stage { background-color: #f0e8ff; }
.card-medcomms { background-color: #fff8e7; }
.card-makeready { background-color: #ffffe0; }
.spinner { display: flex; justify-content: center; padding: 2rem; }
.header-row { align-items: center; margin-bottom: 1rem; }
.shift-links { margin: 1rem 0; }
.search-icon { cursor: pointer; font-size: 1.5rem; }
.search-modal {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 300px;
  background: white;
  padding: 1rem;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  display: none;
  z-index: 1000;
}
.search-modal.active {
  display: block;
}
.search-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.2);
  display: none;
  z-index: 999;
}
.search-backdrop.active {
  display: block;
}
.search-results-header {
  background-color: #f8f9fa;
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1.5rem;
  font-size: 1.2rem;
  font-weight: bold;
}
.initial-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 400px;
  color: #666;
}
.back-to-top {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 40px;
  height: 40px;
  background-color: #0d6efd;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
  z-index: 998;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.back-to-top:hover {
  background-color: #0b5ed7;
}
.back-to-top.visible {
  opacity: 1;
  visibility: visible;
}
html {
  scroll-behavior: smooth;
}
</style>
</head>
<body>
<div class="container">
  <!-- Header Row with Title and Search Icon -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Event Rota</h2>
    <i class="bi bi-search search-icon" onclick="toggleSearch()"></i>
  </div>
  
  <!-- Day Selector -->
  <div class="mb-4">
    <select id="daySelect" class="form-select" onchange="loadRota()" disabled>
      <option>Loading days...</option>
    </select>
  </div>
  
  <!-- Jump Links (shown conditionally) -->
  <div id="shiftLinks" class="shift-links text-center">
    <a href="#early" class="me-2">Early</a> |
    <a href="#late" class="mx-2">Late</a> |
    <a href="#night" class="ms-2">Night</a>
  </div>
  
  <div id="rotaContent">
    <div class="initial-loading">
      <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div>Loading rota data...</div>
    </div>
  </div>
  
  <div class="mt-5 text-center">
    <button class="btn btn-outline-secondary me-2" onclick="forceReloadRota()">Reload Rota</button>
    <button class="btn btn-danger" onclick="clearRotaCache()">Clear Cache</button>
    <div id="dataStatus" class="mt-2" style="font-size: 0.9rem; color: gray;"></div>
    <div id="lastRefresh" class="mt-1" style="font-size: 0.8rem; color: #6c757d;"></div>
  </div>
</div>

<!-- Back to Top Button -->
<div class="back-to-top" onclick="scrollToTop()" title="Back to top">
  <i class="bi bi-arrow-up"></i>
</div>

<!-- Search Modal -->
<div class="search-backdrop" onclick="toggleSearch()"></div>
<div class="search-modal">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Search Crew</h5>
    <i class="bi bi-x-lg" style="cursor: pointer;" onclick="toggleSearch()"></i>
  </div>
  <div class="input-group">
    <input type="text" id="searchInput" class="form-control" placeholder="Enter name..." onkeypress="handleSearchKeyPress(event)">
    <button class="btn btn-primary" onclick="runSearch()">
      <i class="bi bi-search"></i>
    </button>
  </div>
</div>

<script>
// Config
const API_URL = "https://script.google.com/macros/s/AKfycbxp2MxNvj55UUXNDmhqwxxmuRSvRPgbJMFIRR7jbIoE0vwuYQXjIB60O-r__BTngKyJuw/exec";
let rotaCache = [];
let availableDays = [];
let autoRefreshTimer = null;
let isSearchMode = false;
let currentSearchTerm = "";
const AUTO_REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes in milliseconds

function normalizeDay(dayValue) {
    if (!dayValue) return "";
    const clean = dayValue.trim().toLowerCase();
    const daysOfWeek = ["Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday", "Monday"];
    for (const day of daysOfWeek) {
        if (clean.includes(day.toLowerCase())) return day;
    }
    return "";
}

function getShiftType(shiftTitle) {
    const clean = (shiftTitle || "").toLowerCase();
    if (clean.includes("early")) return "Early";
    if (clean.includes("late")) return "Late";
    if (clean.includes("night")) return "Night";
    return "Other";
}

function getBadgeClass(shiftType) {
    if (shiftType === "Early") return "badge-early";
    if (shiftType === "Late") return "badge-late";
    if (shiftType === "Night") return "badge-night";
    return "bg-secondary";
}

function getSectionFromRole(role) {
    const clean = role.trim().toLowerCase();
    if (["duty team leader", "charlie 1", "support"].includes(clean)) return "Leadership";
    if (/^(alpha|whisky|lima)/i.test(role)) return "Vehicles";
    if (/^romeo/i.test(role)) return "Responders";
    if (/^(mike gate|white medical|white alpha|blue medical)/i.test(role)) return "Static Medical Points";
    if (/^stages/i.test(role)) return "Stage Medical";
    if (/^medcomms/i.test(role)) return "Medcomms Team";
    if (/^make/i.test(role)) return "Make Ready Team";
    return "General";
}

function getCardClass(section) {
    const clean = section.toLowerCase();
    if (clean.includes("leadership")) return "card-leadership";
    if (clean.includes("vehicles")) return "card-vehicles";
    if (clean.includes("responders")) return "card-responders";
    if (clean.includes("static")) return "card-static";
    if (clean.includes("stage")) return "card-stage";
    if (clean.includes("medcomms")) return "card-medcomms";
    if (clean.includes("make ready")) return "card-makeready";
    return "";
}

// --- Loading ---
function saveCacheToStorage() {
    localStorage.setItem("rotaCache", JSON.stringify(rotaCache));
    localStorage.setItem("rotaCacheTimestamp", Date.now());
    updateLastRefreshTime();
}

function loadCacheFromStorage() {
    const cached = localStorage.getItem("rotaCache");
    if (cached) {
        updateLastRefreshTime();
        return JSON.parse(cached);
    }
    return [];
}

function isCacheStale(minutes = 15) {
    const lastUpdate = parseInt(localStorage.getItem("rotaCacheTimestamp") || "0");
    return (Date.now() - lastUpdate) > minutes * 60 * 1000;
}

function updateLastRefreshTime() {
    const timestamp = localStorage.getItem("rotaCacheTimestamp");
    if (timestamp) {
        const date = new Date(parseInt(timestamp));
        const timeString = date.toLocaleTimeString();
        document.getElementById("lastRefresh").textContent = `Last refreshed: ${timeString}`;
    }
}

function updateJumpLinksVisibility() {
    const shiftLinks = document.getElementById("shiftLinks");
    shiftLinks.style.display = isSearchMode ? "none" : "block";
}

async function preloadShifts(force = false) {
    rotaCache = loadCacheFromStorage();
    const usingCache = !force && rotaCache.length > 0 && !isCacheStale(15);
    
    if (usingCache) {
        updateAvailableDays();
        updateStatus("Loaded from cache");
        document.getElementById("daySelect").disabled = false;
        return;
    }
    
    try {
        updateStatus("Loading fresh data...");
        const res = await fetch(`${API_URL}?action=loadAllShifts`);
        const rawData = await res.json();
        rotaCache = rawData.map(entry => ({
            shiftTitle: (entry["Section"] || "").trim(),
            role: (entry["Location"] || "").trim(),
            time: `${entry["Start"]} - ${entry["Finish"]}`,
            crew1: (entry["Crew 1"] || "").trim(),
            crew2: (entry["Crew 2"] || "").trim(),
            day: normalizeDay(entry["Day"])
        }));
        saveCacheToStorage();
        updateAvailableDays();
        updateStatus("Live rota loaded");
        document.getElementById("daySelect").disabled = false;
        
        // Reload the current view if we've updated the data
        const currentView = document.getElementById("rotaContent").innerHTML;
        if (currentView && !currentView.includes("No shifts found") && !currentView.includes("initial-loading")) {
            if (isSearchMode) {
                // If in search mode, rerun the search with fresh data
                runSearch();
            } else {
                // Otherwise reload the day view
                loadRota();
            }
        }
    } catch (err) {
        console.error("Error loading rota data:", err);
        updateStatus("Error loading data. Using cached rota");
        document.getElementById("daySelect").disabled = false;
    }
}

function updateAvailableDays() {
    const daysFound = new Set(rotaCache.map(entry => entry.day));
    availableDays = Array.from(daysFound).sort((a, b) => {
        const dayOrder = ["Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday", "Monday"];
        return dayOrder.indexOf(a) - dayOrder.indexOf(b);
    });
    
    const daySelect = document.getElementById("daySelect");
    daySelect.innerHTML = availableDays.map(day => `<option value="${day}">${day}</option>`).join("");
    
    // Check for saved day, if none saved or saved day not available, default to first day
    const savedDay = localStorage.getItem("selectedDay");
    if (savedDay && availableDays.includes(savedDay)) {
        daySelect.value = savedDay;
    } else if (availableDays.length > 0) {
        // Default to the first available day
        daySelect.value = availableDays[0];
        localStorage.setItem("selectedDay", availableDays[0]);
    }
}

function updateStatus(msg) {
    document.getElementById("dataStatus").textContent = msg;
}

// --- Rota Display ---
function loadRota() {
    isSearchMode = false;
    updateJumpLinksVisibility();
    
    const daySelect = document.getElementById("daySelect");
    const day = daySelect.value;
    localStorage.setItem("selectedDay", day);
    
    document.getElementById("rotaContent").innerHTML = 
        '<div class="spinner"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    const dayData = rotaCache.filter(entry => entry.day.toLowerCase() === day.toLowerCase());
    renderGroupedRota(dayData, false);
}

function renderGroupedRota(data, isSearch = false, searchTerm = "") {
    if (!data.length) {
        document.getElementById("rotaContent").innerHTML = "<p>No shifts found.</p>";
        return;
    }
    
    if (isSearch) {
        let html = '';
        
        // Add search results header
        if (searchTerm) {
            html += `<div class="search-results-header">Search results for "${searchTerm}"</div>`;
        }
        
        const groupedByDay = {};
        data.forEach(entry => {
            if (!groupedByDay[entry.day]) groupedByDay[entry.day] = [];
            groupedByDay[entry.day].push(entry);
        });
        
        for (const day in groupedByDay) {
            html += `<h4 class="mt-4">${day}</h4><div class="row g-3 mb-4">`;
            groupedByDay[day].forEach(row => {
                html += `
                <div class="col-12 col-md-6">
                    <div class="card shadow-sm p-3 ${getCardClass(getSectionFromRole(row.role))}">
                        <h5>${row.role}</h5>
                        <p><strong>Time:</strong> ${row.time}</p>
                        <p><strong>Crew 1:</strong> ${row.crew1 || "–"}</p>
                        <p><strong>Crew 2:</strong> ${row.crew2 || "–"}</p>
                    </div>
                </div>
                `;
            });
            html += `</div>`;
        }
        document.getElementById("rotaContent").innerHTML = html;
        return;
    }
    
    const groupedByShift = { Early: [], Late: [], Night: [], Other: [] };
    data.forEach(entry => groupedByShift[getShiftType(entry.shiftTitle)].push(entry));
    
    let html = "";
    for (const shiftType of ["Early", "Late", "Night", "Other"]) {
        if (!groupedByShift[shiftType].length) continue;
        
        const selectedDay = document.getElementById("daySelect")?.value || "";
        html += `
        <div id="${shiftType.toLowerCase()}" class="shift-header my-5">
            <span class="badge ${getBadgeClass(shiftType)} p-2">${selectedDay} ${shiftType} Shifts</span>
        </div>
        `;
        
        const groupedBySection = {};
        groupedByShift[shiftType].forEach(entry => {
            const section = getSectionFromRole(entry.role);
            if (!groupedBySection[section]) groupedBySection[section] = [];
            groupedBySection[section].push(entry);
        });
        
        for (const section in groupedBySection) {
            html += `<div class="section-header">${section}</div><div class="row g-3 mb-4">`;
            html += groupedBySection[section].map(row => `
            <div class="col-12 col-md-6">
                <div class="card shadow-sm p-3 ${getCardClass(section)}">
                    <h5>${row.role}</h5>
                    <p><strong>Time:</strong> ${row.time}</p>
                    <p><strong>Crew 1:</strong> ${row.crew1 || "–"}</p>
                    <p><strong>Crew 2:</strong> ${row.crew2 || "–"}</p>
                </div>
            </div>
            `).join("");
            html += `</div>`;
        }
    }
    document.getElementById("rotaContent").innerHTML = html;
}

// --- Search Functions ---
function toggleSearch() {
    const modal = document.querySelector('.search-modal');
    const backdrop = document.querySelector('.search-backdrop');
    const isActive = modal.classList.contains('active');
    
    if (isActive) {
        modal.classList.remove('active');
        backdrop.classList.remove('active');
    } else {
        modal.classList.add('active');
        backdrop.classList.add('active');
        document.getElementById('searchInput').focus();
    }
}

function handleSearchKeyPress(event) {
    if (event.key === 'Enter') {
        runSearch();
    }
}

function runSearch() {
    const query = document.getElementById("searchInput").value.trim().toLowerCase();
    if (!query) return alert("Please enter a name to search.");
    
    isSearchMode = true;
    currentSearchTerm = query;
    updateJumpLinksVisibility();
    toggleSearch(); // Close the search modal
    
    const matches = [];
    const foundNames = new Set();
    
    rotaCache.forEach(entry => {
        if (entry.crew1.toLowerCase().includes(query)) 
            foundNames.add(entry.crew1.trim());
        if (entry.crew2.toLowerCase().includes(query)) 
            foundNames.add(entry.crew2.trim());
        
        if (entry.crew1.toLowerCase().includes(query) || entry.crew2.toLowerCase().includes(query)) {
            matches.push(entry);
        }
    });
    
    const uniqueNames = Array.from(foundNames);
    
    if (!matches.length) {
        document.getElementById("rotaContent").innerHTML = `
            <div class="search-results-header">Search results for "${query}"</div>
            <p>No shifts found for that name.</p>
        `;
    } else if (uniqueNames.length > 1) {
        const nameList = uniqueNames.map(name => 
            `<li><a href="#" onclick="filterByExactName('${name.replace(/'/g, "\\'")}')">${name}</a></li>`
        ).join("");
        
        document.getElementById("rotaContent").innerHTML = `
        <div class="search-results-header">Search results for "${query}"</div>
        <p>Multiple matches found. Please choose:</p>
        <ul>${nameList}</ul>
        `;
    } else {
        filterByExactName(uniqueNames[0], query);
    }
}

function filterByExactName(name, originalSearch = "") {
    const results = rotaCache.filter(entry => 
        entry.crew1.trim().toLowerCase() === name.trim().toLowerCase() || 
        entry.crew2.trim().toLowerCase() === name.trim().toLowerCase()
    );
    renderGroupedRota(results, true, name);
}

function forceReloadRota() {
    preloadShifts(true).then(() => {
        if (isSearchMode) {
            runSearch();
        } else {
            loadRota();
        }
    });
}

function clearRotaCache() {
    if (confirm("Clear cache and reload?")) {
        localStorage.clear();
        location.reload();
    }
}

// --- Auto Refresh --- 
function startAutoRefresh() {
    // Clear any existing timers first
    if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
    }
    
    // Set up the auto-refresh timer to run every 5 minutes
    autoRefreshTimer = setInterval(() => {
        console.log("Auto-refreshing rota data...");
        preloadShifts(true); // Force refresh the data
    }, AUTO_REFRESH_INTERVAL);
    
    // Also refresh when the page regains focus
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            console.log("Page is visible again, refreshing data...");
            preloadShifts(true);
        }
    });
}

// --- Back to Top Button ---
function handleScroll() {
    const backToTopBtn = document.querySelector('.back-to-top');
    if (window.scrollY > 200) {
        backToTopBtn.classList.add('visible');
    } else {
        backToTopBtn.classList.remove('visible');
    }
}

function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// --- Initialization ---
window.onload = async () => {
    await preloadShifts();
    loadRota();
    startAutoRefresh();
    
    // Set up scroll event listener for back to top button
    window.addEventListener('scroll', handleScroll);
};
</script>
</body>
</html>
