<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rota Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 1rem;
      background-color: #f9f9f9;
    }
    h2 {
      font-size: 1.8rem;
      font-weight: bold;
      margin-bottom: 1.5rem;
    }
    h3 {
      margin-top: 2rem;
      font-size: 1.4rem;
      border-bottom: 2px solid #ddd;
      padding-bottom: 0.3rem;
    }
    h5 {
      margin-top: 1rem;
      font-weight: 600;
    }
    .spinner {
      display: flex;
      justify-content: center;
      padding: 2rem;
    }
    .card {
      border-radius: 0.75rem;
    }
    .card p {
      font-size: 0.95rem;
    }
    .card-leadership {
      background-color: #e7f3ff;
    }
    .card-vehicle {
      background-color: #f0f0f0;
    }
    .card-responders {
      background-color: #e8fbe8;
    }
    .card-medcomms {
      background-color: #fff0f6;
    }
    .card-makeready {
      background-color: #fefce8;
    }
    .card-duty-leader {
      border-left: 5px solid gold;
      background-color: #fffbe6;
      position: relative;
    }
    .card-duty-leader::before {
      content: "⭐ Duty Team Leader";
      position: absolute;
      top: 0;
      left: 0;
      background-color: gold;
      color: black;
      padding: 0.2rem 0.6rem;
      font-weight: bold;
      font-size: 0.75rem;
      border-bottom-right-radius: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Event Rota V3.02</h2>

    <label for="daySelect" class="form-label">Select Day:</label>
    <select id="daySelect" class="form-select mb-3" onchange="filterByDay()">
      <option value="">All Days</option>
      <option>Tuesday</option>
      <option>Wednesday</option>
      <option>Thursday</option>
      <option>Friday</option>
      <option>Saturday</option>
      <option>Sunday</option>
      <option>Monday</option>
    </select>

    <label for="searchInput" class="form-label">Search by name, role, or section:</label>
    <input type="text" id="searchInput" class="form-control mb-4" placeholder="e.g. Mark, Medic, Vehicle..." oninput="filterData()">

    <div id="rotaContent">
      <div class="spinner">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwfYlAX7pg7JqQKO9S9N6aVglWFf4exAgzpqVsil2q3-P2uNBQN3agk2NMk0HAgbb93/exec"; // Replace with your Script URL
    let weeklyData = []; // All shifts from all days
    let currentDay = "";
    let currentSearch = "";

    function loadWeeklyRota() {
      fetch(API_URL)
        .then(response => response.json())
        .then(data => {
          weeklyData = [];

          for (const day in data) {
            data[day].forEach(shift => {
              weeklyData.push({ ...shift, day });
            });
          }

          filterData();
        })
        .catch(err => {
          console.error("Error loading weekly rota:", err);
          document.getElementById("rotaContent").innerHTML = "<p>Error loading rota data.</p>";
        });
    }

    function filterByDay() {
      currentDay = document.getElementById("daySelect").value;
      localStorage.setItem("selectedDay", currentDay);
      filterData();
    }

    function filterData() {
      currentSearch = document.getElementById("searchInput").value.toLowerCase().trim();
      let filtered = weeklyData;

      if (currentDay) {
        filtered = filtered.filter(entry => entry.day === currentDay);
      }

      if (currentSearch) {
        filtered = filtered.filter(entry =>
          (entry.role || "").toLowerCase().includes(currentSearch) ||
          (entry.time || "").toLowerCase().includes(currentSearch) ||
          (entry.section || "").toLowerCase().includes(currentSearch) ||
          (entry.crew1 || "").toLowerCase().includes(currentSearch) ||
          (entry.crew2 || "").toLowerCase().includes(currentSearch)
        );
      }

      renderRota(filtered);
    }

    function renderRota(data) {
      if (!data || data.length === 0) {
        document.getElementById("rotaContent").innerHTML = "<p>No matching shifts found.</p>";
        return;
      }

      let html = "";

      const grouped = {};
      data.forEach(row => {
        const key = `${row.day}::${row.shiftTitle}`;
        if (!grouped[key]) grouped[key] = { day: row.day, title: row.shiftTitle, entries: [] };
        grouped[key].entries.push(row);
      });

      for (const key in grouped) {
        const group = grouped[key];
        html += `<h3>${group.title} Shifts – ${group.day}</h3>`;

        const sectionGroups = {};
        group.entries.forEach(row => {
          if (!sectionGroups[row.section]) sectionGroups[row.section] = [];
          sectionGroups[row.section].push(row);
        });

        for (const section in sectionGroups) {
          html += `<h5>${section}</h5>`;
          const rows = sectionGroups[section];

          html += `<div class="row g-2">`;
          rows.forEach(row => {
            const sectionLower = row.section.toLowerCase();
            const roleLower = (row.role || "").toLowerCase();

            const cardClass =
              sectionLower.includes("leadership") ? "card-leadership" :
              sectionLower.includes("vehicle") ? "card-vehicle" :
              sectionLower.includes("responders") ? "card-responders" :
              sectionLower.includes("medcomms") ? "card-medcomms" :
              sectionLower.includes("make ready") ? "card-makeready" :
              "";

            const isDutyLeader = roleLower.includes("duty team leader");
            const fullCardClass = `card h-100 shadow-sm ${cardClass} ${isDutyLeader ? "card-duty-leader" : ""}`;

            html += `
              <div class="col-12 col-md-6 col-lg-4">
                <div class="${fullCardClass}">
                  <div class="card-body p-3">
                    <p class="mb-1"><strong>Day:</strong> ${row.day}</p>
                    <p class="mb-1"><strong>Role:</strong> ${row.role || "<span class='text-muted'>–</span>"}</p>
                    <p class="mb-1"><strong>Time:</strong> ${row.time || "<span class='text-muted'>–</span>"}</p>
                    <p class="mb-1"><strong>Crew 1:</strong> ${row.crew1 || "<span class='text-muted'>–</span>"}</p>
                    <p class="mb-0"><strong>Crew 2:</strong> ${row.crew2 || "<span class='text-muted'>–</span>"}</p>
                  </div>
                </div>
              </div>
            `;
          });
          html += `</div>`;
        }
      }

      document.getElementById("rotaContent").innerHTML = html;
    }

    window.onload = () => {
      const savedDay = localStorage.getItem("selectedDay");
      if (savedDay) document.getElementById("daySelect").value = savedDay;
      loadWeeklyRota();
    };
  </script>
</body>
</html>
