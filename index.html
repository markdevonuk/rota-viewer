<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Event Rota Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 1rem; background-color: #f9f9f9; }
    h2 { font-size: 1.8rem; font-weight: bold; margin-bottom: 1rem; }
    .shift-header { margin-top: 3rem; text-align: center; }
    .section-header { margin-top: 2rem; font-size: 1.5rem; font-weight: bold; }
    .card { border-radius: 0.75rem; }
    .badge-early { background-color: #0d6efd; color: #fff; font-size: 1rem; }
    .badge-late { background-color: #6f42c1; color: #fff; font-size: 1rem; }
    .badge-night { background-color: #212529; color: #fff; font-size: 1rem; }
    .card-leadership { background-color: #e7f3ff; }
    .card-vehicles { background-color: #f0f0f0; }
    .card-responders { background-color: #e8fbe8; }
    .card-static { background-color: #ffe4e1; }
    .card-stage { background-color: #f0e8ff; }
    .card-medcomms { background-color: #fff8e7; }
    .card-makeready { background-color: #ffffe0; }
    .spinner { display: flex; justify-content: center; padding: 2rem; }
    .search-container { position: absolute; top: 1rem; right: 1rem; display: flex; align-items: center; }
    #searchInput { width: 0; transition: width 0.3s; overflow: hidden; }
    #searchInput.active { width: 300px; }
    .search-icon { background: none; border: none; font-size: 1.5rem; margin-left: 10px; }
  </style>
</head>
<body>

<div class="container position-relative">
  <div class="text-center">
    <h2>Event Rota</h2>

    <label for="daySelect" class="form-label">Select Day:</label>
    <select id="daySelect" class="form-select mb-3" style="max-width: 300px; margin: 0 auto;" onchange="loadRota()"></select>

    <div id="shiftLinks" class="mb-4">
      <a href="#early" class="me-2">Early</a> |
      <a href="#late" class="mx-2">Late</a> |
      <a href="#night" class="ms-2">Night</a>
    </div>
  </div>

  <div class="search-container">
    <input type="text" id="searchInput" class="form-control" placeholder="Enter full or partial name..." onkeydown="if(event.key==='Enter'){runSearch()}" />
    <button class="search-icon" onclick="toggleSearch()">üîç</button>
  </div>

  <div id="rotaContent" class="mt-4"></div>

  <div class="mt-5 text-center">
    <button class="btn btn-outline-secondary me-2" onclick="forceReloadRota()">Reload Rota</button>
    <button class="btn btn-danger" onclick="clearRotaCache()">Clear Cache</button>
    <div id="dataStatus" class="mt-2" style="font-size: 0.9rem; color: gray;"></div>
  </div>
</div>

<script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxp2MxNvj55UUXNDmhqwxxmuRSvRPgbJMFIRR7jbIoE0vwuYQXjIB60O-r__BTngKyJuw/exec";

let rotaCache = [];
let availableDays = [];
let isSearchMode = false;

// Helpers
function normalizeDay(dayValue) {
  if (!dayValue) return "";
  const clean = dayValue.trim().toLowerCase();
  const daysOfWeek = ["Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday", "Monday"];
  for (const day of daysOfWeek) {
    if (clean.includes(day.toLowerCase())) return day;
  }
  return "";
}

function getShiftType(shiftTitle) {
  const clean = (shiftTitle || "").toLowerCase();
  if (clean.includes("early")) return "Early";
  if (clean.includes("late")) return "Late";
  if (clean.includes("night")) return "Night";
  return "Other";
}

function getBadgeClass(shiftType) {
  if (shiftType === "Early") return "badge-early";
  if (shiftType === "Late") return "badge-late";
  if (shiftType === "Night") return "badge-night";
  return "bg-secondary";
}

function getSectionFromRole(role) {
  const clean = role.trim().toLowerCase();
  if (["duty team leader", "charlie 1", "support"].includes(clean)) return "Leadership";
  if (/^(alpha|whisky|lima)/i.test(role)) return "Vehicles";
  if (/^romeo/i.test(role)) return "Responders";
  if (/^(mike gate|white medical|white alpha|blue medical)/i.test(role)) return "Static Medical Points";
  if (/^stages/i.test(role)) return "Stage Medical";
  if (/^medcomms/i.test(role)) return "Medcomms Team";
  if (/^make/i.test(role)) return "Make Ready Team";
  return "General";
}

function getCardClass(section) {
  const clean = section.toLowerCase();
  if (clean.includes("leadership")) return "card-leadership";
  if (clean.includes("vehicles")) return "card-vehicles";
  if (clean.includes("responders")) return "card-responders";
  if (clean.includes("static")) return "card-static";
  if (clean.includes("stage")) return "card-stage";
  if (clean.includes("medcomms")) return "card-medcomms";
  if (clean.includes("make ready")) return "card-makeready";
  return "";
}

// Cache and preload
function saveCacheToStorage() {
  localStorage.setItem("rotaCache", JSON.stringify(rotaCache));
  localStorage.setItem("rotaCacheTimestamp", Date.now());
}

function loadCacheFromStorage() {
  const cached = localStorage.getItem("rotaCache");
  return cached ? JSON.parse(cached) : [];
}

function isCacheStale(minutes = 15) {
  const lastUpdate = parseInt(localStorage.getItem("rotaCacheTimestamp") || "0");
  return (Date.now() - lastUpdate) > minutes * 60 * 1000;
}

async function preloadShifts(force = false) {
  rotaCache = loadCacheFromStorage();
  const usingCache = !force && rotaCache.length > 0 && !isCacheStale(15);

  if (usingCache) {
    updateAvailableDays();
    updateStatus("Loaded from cache");
    return;
  }

  try {
    const res = await fetch(`${API_URL}?action=loadAllShifts`);
    const rawData = await res.json();

    rotaCache = rawData.map(entry => ({
      shiftTitle: (entry["Section"] || "").trim(),
      role: (entry["Location"] || "").trim(),
      time: `${entry["Start"]} - ${entry["Finish"]}`,
      crew1: (entry["Crew 1"] || "").trim(),
      crew2: (entry["Crew 2"] || "").trim(),
      day: normalizeDay(entry["Day"])
    }));

    saveCacheToStorage();
    updateAvailableDays();
    updateStatus("Live rota loaded");
  } catch (err) {
    updateStatus("‚ö† Using cached rota");
  }
}

function updateAvailableDays() {
  const daysFound = new Set(rotaCache.map(entry => entry.day));
  availableDays = Array.from(daysFound).sort((a, b) => {
    const dayOrder = ["Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday", "Monday"];
    return dayOrder.indexOf(a) - dayOrder.indexOf(b);
  });

  const daySelect = document.getElementById("daySelect");
  daySelect.innerHTML = availableDays.map(day => `<option value="${day}">${day}</option>`).join("");

  const savedDay = localStorage.getItem("selectedDay");
  if (savedDay && availableDays.includes(savedDay)) {
    daySelect.value = savedDay;
  }
}

function updateStatus(msg) {
  document.getElementById("dataStatus").textContent = msg;
}

// Display
function loadRota() {
  isSearchMode = false;
  document.getElementById("shiftLinks").style.display = "block";

  const daySelect = document.getElementById("daySelect");
  const day = daySelect.value;
  localStorage.setItem("selectedDay", day);

  document.getElementById("rotaContent").innerHTML =
    '<div class="spinner"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';

  const dayData = rotaCache.filter(entry => entry.day.toLowerCase() === day.toLowerCase());
  renderGroupedRota(dayData, false);
}

function renderGroupedRota(data, isSearch = false) {
  if (isSearch) {
    document.getElementById("shiftLinks").style.display = "none";
  } else {
    document.getElementById("shiftLinks").style.display = "block";
  }

  if (!data.length) {
    document.getElementById("rotaContent").innerHTML = "<p>No shifts found.</p>";
    return;
  }

  if (isSearch) {
    const groupedByDay = {};

    data.forEach(entry => {
      if (!groupedByDay[entry.day]) groupedByDay[entry.day] = [];
      groupedByDay[entry.day].push(entry);
    });

    let html = "";

    for (const day in groupedByDay) {
      html += `<h4 class="mt-4">${day}</h4><div class="row g-3 mb-4">`;
      groupedByDay[day].forEach(row => {
        html += `
          <div class="col-12 col-md-6">
            <div class="card shadow-sm p-3 ${getCardClass(getSectionFromRole(row.role))}">
              <h5>${row.role}</h5>
              <p><strong>Time:</strong> ${row.time}</p>
              <p><strong>Crew 1:</strong> ${row.crew1 || "‚Äì"}</p>
              <p><strong>Crew 2:</strong> ${row.crew2 || "‚Äì"}</p>
            </div>
          </div>
        `;
      });
      html += `</div>`;
    }

    document.getElementById("rotaContent").innerHTML = html;
    return;
  }

  const groupedByShift = { Early: [], Late: [], Night: [], Other: [] };
  data.forEach(entry => groupedByShift[getShiftType(entry.shiftTitle)].push(entry));

  let html = "";

  for (const shiftType of ["Early", "Late", "Night", "Other"]) {
    if (!groupedByShift[shiftType].length) continue;

    const selectedDay = document.getElementById("daySelect")?.value || "";

    html += `
      <div id="${shiftType.toLowerCase()}" class="shift-header my-5">
        <span class="badge ${getBadgeClass(shiftType)} p-2">${selectedDay} ${shiftType} Shifts</span>
      </div>
    `;

    const groupedBySection = {};
    groupedByShift[shiftType].forEach(entry => {
      const section = getSectionFromRole(entry.role);
      if (!groupedBySection[section]) groupedBySection[section] = [];
      groupedBySection[section].push(entry);
    });

    for (const section in groupedBySection) {
      html += `<div class="section-header">${section}</div><div class="row g-3 mb-4">`;
      html += groupedBySection[section].map(row => `
        <div class="col-12 col-md-6">
          <div class="card shadow-sm p-3 ${getCardClass(section)}">
            <h5>${row.role}</h5>
            <p><strong>Time:</strong> ${row.time}</p>
            <p><strong>Crew 1:</strong> ${row.crew1 || "‚Äì"}</p>
            <p><strong>Crew 2:</strong> ${row.crew2 || "‚Äì"}</p>
          </div>
        </div>
      `).join("");
      html += `</div>`;
    }
  }

  document.getElementById("rotaContent").innerHTML = html;
}

// Search
function runSearch() {
  const query = document.getElementById("searchInput").value.trim().toLowerCase();
  if (!query) return alert("Please enter a name to search.");
  isSearchMode = true;

  const matches = [];
  const foundNames = new Set();

  rotaCache.forEach(entry => {
    if (entry.crew1.toLowerCase().includes(query)) foundNames.add(entry.crew1.trim());
    if (entry.crew2.toLowerCase().includes(query)) foundNames.add(entry.crew2.trim());
    if (entry.crew1.toLowerCase().includes(query) || entry.crew2.toLowerCase().includes(query)) {
      matches.push(entry);
    }
  });

  const uniqueNames = Array.from(foundNames);

  if (!matches.length) {
    document.getElementById("rotaContent").innerHTML = "<p>No shifts found for that name.</p>";
  } else if (uniqueNames.length > 1) {
    const nameList = uniqueNames.map(name => `<li><a href="#" onclick="filterByExactName('${name.replace(/'/g, "\\'")}')">${name}</a></li>`).join("");
    document.getElementById("rotaContent").innerHTML = `
      <p>Multiple matches found. Please choose:</p>
      <ul>${nameList}</ul>
    `;
  } else {
    filterByExactName(uniqueNames[0]);
  }
}

function filterByExactName(name) {
  const results = rotaCache.filter(entry =>
    entry.crew1.trim().toLowerCase() === name.trim().toLowerCase() ||
    entry.crew2.trim().toLowerCase() === name.trim().toLowerCase()
  );
  renderGroupedRota(results, true);
}

function forceReloadRota() {
  preloadShifts(true).then(loadRota);
}

function clearRotaCache() {
  if (confirm("Clear cache and reload?")) {
    localStorage.clear();
    location.reload();
  }
}

function toggleSearch() {
  const input = document.getElementById("searchInput");
  input.classList.toggle("active");
  input.focus();
}

// On load
window.onload = async () => {
  await preloadShifts();
  loadRota();
};

// Refresh cache every 5 minutes
setInterval(() => {
  if (isCacheStale(15)) {
    console.log("Cache is stale, refreshing rota...");
    preloadShifts(true).then(loadRota);
  }
}, 5 * 60 * 1000);


</script>

</body>
</html>
