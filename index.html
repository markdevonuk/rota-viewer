<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Event Rota Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    html { scroll-behavior: smooth; }
    body { padding: 1rem; background-color: #f9f9f9; }
    h2 { font-size: 1.8rem; font-weight: bold; margin-bottom: 1rem; }
    h5 { margin-top: 1rem; font-weight: 600; }
    .spinner { display: flex; justify-content: center; padding: 2rem; }
    .card { border-radius: 0.75rem; }
    .section-block { margin-bottom: 2rem; }
  </style>
</head>
<body>

<div class="container">
  <h2>Event Rota V11</h2>

  <div class="mb-4">
    <label for="daySelect" class="form-label">Select Day:</label>
    <select id="daySelect" class="form-select" onchange="loadRota()"></select>
  </div>

  <div id="rotaContent">
    <div class="spinner">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  </div>

  <div class="mt-5 text-center">
    <button class="btn btn-outline-secondary me-2" onclick="forceReloadRota()">Reload Rota Data</button>
    <button class="btn btn-danger" onclick="clearRotaCache()">Clear Cache</button>
    <div id="dataStatus" class="mt-2" style="font-size: 0.9rem; color: gray;"></div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxp2MxNvj55UUXNDmhqwxxmuRSvRPgbJMFIRR7jbIoE0vwuYQXjIB60O-r__BTngKyJuw/exec"; // <-- Insert your real URL
let rotaCache = [];
let availableDays = [];

function normalizeDay(dayValue) {
  if (!dayValue) return "";

  const clean = dayValue.trim().toLowerCase();

  const daysOfWeek = ["Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday", "Monday"];
  for (const day of daysOfWeek) {
    if (clean.includes(day.toLowerCase())) return day;
  }
  return "";
}

function saveCacheToStorage() {
  localStorage.setItem("rotaCache", JSON.stringify(rotaCache));
  localStorage.setItem("rotaCacheTimestamp", Date.now());
}

function loadCacheFromStorage() {
  const cached = localStorage.getItem("rotaCache");
  return cached ? JSON.parse(cached) : [];
}

function isCacheStale(minutes = 15) {
  const lastUpdate = parseInt(localStorage.getItem("rotaCacheTimestamp") || "0");
  return (Date.now() - lastUpdate) > minutes * 60 * 1000;
}

async function preloadShifts(force = false) {
  rotaCache = loadCacheFromStorage();
  const usingCache = !force && rotaCache.length > 0 && !isCacheStale(15);

  if (usingCache) {
    updateAvailableDays();
    updateStatus("Loaded from local cache");
    return;
  }

  try {
    const res = await fetch(`${API_URL}?action=loadAllShifts`);
    const rawData = await res.json();

    rotaCache = rawData.map(entry => {
      const role = (entry["Location"] || "").trim();
      const start = entry["Start"];
      const finish = entry["Finish"];
      return {
        shiftTitle: (entry["Section"] || "").trim(),
        role,
        time: `${start} - ${finish}`,
        crew1: (entry["Crew 1"] || "").trim(),
        crew2: (entry["Crew 2"] || "").trim(),
        day: normalizeDay(entry["Day"])
      };
    });

    saveCacheToStorage();
    updateAvailableDays();
    updateStatus("Live rota loaded");
  } catch (err) {
    updateStatus("⚠️ Using cached rota (offline)");
  }
}

function updateAvailableDays() {
  const daysFound = new Set(rotaCache.map(entry => entry.day));
  availableDays = Array.from(daysFound).sort((a, b) => {
    const dayOrder = ["Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday", "Monday"];
    return dayOrder.indexOf(a) - dayOrder.indexOf(b);
  });

  const daySelect = document.getElementById("daySelect");
  daySelect.innerHTML = availableDays.map(day => `<option value="${day}">${day}</option>`).join("");

  const savedDay = localStorage.getItem("selectedDay");
  if (savedDay && availableDays.includes(savedDay)) {
    daySelect.value = savedDay;
  }
}

function loadRota() {
  const daySelect = document.getElementById("daySelect");
  const day = daySelect.value;
  localStorage.setItem("selectedDay", day);

  document.getElementById("rotaContent").innerHTML =
    '<div class="spinner"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';

  const dayData = rotaCache.filter(entry => entry.day.toLowerCase() === day.toLowerCase());

  renderRota(dayData);
}

function renderRota(data) {
  if (!data.length) {
    document.getElementById("rotaContent").innerHTML = "<p>No rota found for this day.</p>";
    return;
  }

  let html = `<div class="row g-3">`;

  html += data.map(row => `
    <div class="col-12 col-md-6">
      <div class="card shadow-sm p-3">
        <h5>${row.role}</h5>
        <p><strong>Time:</strong> ${row.time}</p>
        <p><strong>Crew 1:</strong> ${row.crew1 || "–"}</p>
        <p><strong>Crew 2:</strong> ${row.crew2 || "–"}</p>
      </div>
    </div>
  `).join("");

  html += `</div>`;

  document.getElementById("rotaContent").innerHTML = html;
}

function updateStatus(msg) {
  document.getElementById("dataStatus").textContent = msg;
}

function forceReloadRota() {
  preloadShifts(true).then(loadRota);
}

function clearRotaCache() {
  if (confirm("Clear rota cache and reload?")) {
    localStorage.clear();
    location.reload();
  }
}

window.onload = async () => {
  await preloadShifts();
  loadRota();
};
</script>

</body>
</html>
