<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Event Rota Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 1rem; background-color: #f9f9f9; }
    h2 { font-size: 1.8rem; font-weight: bold; margin-bottom: 1rem; }
    .shift-header { margin-top: 3rem; text-align: center; }
    .section-header { margin-top: 2rem; font-size: 1.5rem; font-weight: bold; }
    .card { border-radius: 0.75rem; }
    .badge-early { background-color: #0d6efd; color: #fff; font-size: 1rem; }
    .badge-late { background-color: #6f42c1; color: #fff; font-size: 1rem; }
    .badge-night { background-color: #212529; color: #fff; font-size: 1rem; }
    .card-leadership { background-color: #e7f3ff; }
    .card-vehicles { background-color: #f0f0f0; }
    .card-responders { background-color: #e8fbe8; }
    .card-static { background-color: #ffe4e1; }
    .card-stage { background-color: #f0e8ff; }
    .card-medcomms { background-color: #fff8e7; }
    .card-makeready { background-color: #ffffe0; }
    .spinner { display: flex; justify-content: center; padding: 2rem; }
  </style>
</head>
<body>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Event Rota</h2>
    <div style="position: relative;">
      <button id="searchToggle" class="btn btn-light" style="border: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-zoom-in" viewBox="0 0 16 16">
          <path d="M6.5 12a5.5 5.5 0 1 1 3.673-9.648A5.5 5.5 0 0 1 6.5 12zm2-5a.5.5 0 0 1 .5.5v1h1a.5.5 0 0 1 0 1h-1v1a.5.5 0 0 1-1 0v-1h-1a.5.5 0 0 1 0-1h1v-1a.5.5 0 0 1 .5-.5z"/>
          <path d="M13.442 12.442a1 1 0 0 0-1.415-1.415l-3.588 3.588a1 1 0 1 0 1.415 1.415l3.588-3.588z"/>
        </svg>
      </button>
      <div id="searchBar" style="display: none; min-width: 300px; position: absolute; right: 0; top: 40px; background: white; padding: 0.5rem; box-shadow: 0 2px 6px rgba(0,0,0,0.2); border-radius: 0.5rem;">
        <div class="input-group">
          <input type="text" id="searchInput" class="form-control" placeholder="Enter name..." onkeydown="if (event.key === 'Enter') runSearch()">
          <button class="btn btn-primary" onclick="runSearch()">Search</button>
        </div>
      </div>
    </div>
  </div>

  <div class="mb-4">
    <label for="daySelect" class="form-label">Select Day:</label>
    <select id="daySelect" class="form-select" onchange="loadRota()"></select>
  </div>

  <div class="mb-4 text-center">
    <a href="#early" class="me-2">Early</a> |
    <a href="#late" class="mx-2">Late</a> |
    <a href="#night" class="ms-2">Night</a>
  </div>

  <div id="rotaContent"></div>

  <div class="mt-5 text-center">
    <button class="btn btn-outline-secondary me-2" onclick="forceReloadRota()">Reload Rota</button>
    <button class="btn btn-danger" onclick="clearRotaCache()">Clear Cache</button>
    <div id="dataStatus" class="mt-2" style="font-size: 0.9rem; color: gray;"></div>
  </div>
</div>

<script>
// Your existing script functions go here, updated slightly to accept selectedName
const API_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; 
let rotaCache = [];
let availableDays = [];

function normalizeDay(dayValue) { ... }
function getShiftType(shiftTitle) { ... }
function getBadgeClass(shiftType) { ... }
function getSectionFromRole(role) { ... }
function getCardClass(section) { ... }
function saveCacheToStorage() { ... }
function loadCacheFromStorage() { ... }
function isCacheStale(minutes = 15) { ... }
async function preloadShifts(force = false) { ... }
function updateAvailableDays() { ... }
function updateStatus(msg) { ... }
function loadRota() { ... }

function renderGroupedRota(data, isSearch = false, selectedName = "") {
  if (!data.length) {
    document.getElementById("rotaContent").innerHTML = "<p>No shifts found.</p>";
    return;
  }

  if (isSearch) {
    const groupedByDay = {};
    data.forEach(entry => {
      if (!groupedByDay[entry.day]) groupedByDay[entry.day] = [];
      groupedByDay[entry.day].push(entry);
    });

    let html = "";

    for (const day in groupedByDay) {
      html += `<h4 class="mt-4">Shifts for ${selectedName} on ${day}</h4><div class="row g-3 mb-4">`;
      groupedByDay[day].forEach(row => {
        html += `
          <div class="col-12 col-md-6">
            <div class="card shadow-sm p-3 ${getCardClass(getSectionFromRole(row.role))}">
              <h5>${row.role}</h5>
              <p><strong>Time:</strong> ${row.time}</p>
              <p><strong>Crew 1:</strong> ${row.crew1 || "–"}</p>
              <p><strong>Crew 2:</strong> ${row.crew2 || "–"}</p>
            </div>
          </div>
        `;
      });
      html += `</div>`;
    }

    document.getElementById("rotaContent").innerHTML = html;
    return;
  }

  const groupedByShift = { Early: [], Late: [], Night: [], Other: [] };
  data.forEach(entry => groupedByShift[getShiftType(entry.shiftTitle)].push(entry));

  let html = "";

  for (const shiftType of ["Early", "Late", "Night", "Other"]) {
    if (!groupedByShift[shiftType].length) continue;
    const selectedDay = document.getElementById("daySelect")?.value || "";
    html += `
      <div id="${shiftType.toLowerCase()}" class="shift-header my-5">
        <span class="badge ${getBadgeClass(shiftType)} p-2">${selectedDay} ${shiftType} Shifts</span>
      </div>
    `;

    const groupedBySection = {};
    groupedByShift[shiftType].forEach(entry => {
      const section = getSectionFromRole(entry.role);
      if (!groupedBySection[section]) groupedBySection[section] = [];
      groupedBySection[section].push(entry);
    });

    for (const section in groupedBySection) {
      html += `<div class="section-header">${section}</div><div class="row g-3 mb-4">`;
      html += groupedBySection[section].map(row => `
        <div class="col-12 col-md-6">
          <div class="card shadow-sm p-3 ${getCardClass(section)}">
            <h5>${row.role}</h5>
            <p><strong>Time:</strong> ${row.time}</p>
            <p><strong>Crew 1:</strong> ${row.crew1 || "–"}</p>
            <p><strong>Crew 2:</strong> ${row.crew2 || "–"}</p>
          </div>
        </div>
      `).join("");
      html += `</div>`;
    }
  }

  document.getElementById("rotaContent").innerHTML = html;
}

function runSearch() { ... }
function filterByExactName(name) {
  const results = rotaCache.filter(entry =>
    entry.crew1.trim().toLowerCase() === name.trim().toLowerCase() ||
    entry.crew2.trim().toLowerCase() === name.trim().toLowerCase()
  );
  renderGroupedRota(results, true, name);
}
function forceReloadRota() { preloadShifts(true).then(loadRota); }
function clearRotaCache() { if (confirm("Clear cache and reload?")) { localStorage.clear(); location.reload(); } }

window.onload = async () => {
  await preloadShifts();
  loadRota();
};

// Toggle the Search Bar open/close
document.getElementById("searchToggle").addEventListener("click", () => {
  const bar = document.getElementById("searchBar");
  bar.style.display = (bar.style.display === "none" || bar.style.display === "") ? "block" : "none";
});
</script>
</body>
</html>



